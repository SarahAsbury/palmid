---
title: "Open Virome: RNA Virus Report"
output:
  html_notebook:
    code_folding: hide
params:
  input.path: 'data/waxsys'
  prod.run: FALSE
---

`palmID` is a contained analysis suite for viral RNA-dependent RNA polymerases
(RdRP) based on the "Palmprint" RNA virus barcodes described by [Babaian and Edgar, 2021](https://www.biorxiv.org/content/10.1101/2021.03.02.433648v1).

## Initialize

```{r setup, include=FALSE}
# RMarkdown Setting Initialization
# Command Line Interface ----

# Rscript -e "rmarkdown::render( \
#   input = 'palmid_dev.Rmd', \
#   output_file = 'amexnv.html', \
#   output_format = 'html_notebook', \
#   params=list( input.path = 'amexnv/amexnv'))"

# ---------------------------

knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{css, echo=FALSE}
/* Move code folding buttons to the left */
div.col-md-12 .pull-right {
  float: left !important
}
```
```{r, include=FALSE, warning=FALSE}
# Run as Production Pipeline or Development
production.version = params$prod.run

if (production.version){
  # Load stable palmid package
  library('palmid', quietly = T)
  load("/home/palmid/data/palmdb.Rdata") 

  # Disable warnings
   options(warn = -1) 
} else {
  
  # Compile a new palmid from source
  library(roxygen2)
    roxygen2::roxygenise()
    load("data/palmdb.Rdata")
}

```

```{r}
# INITIALIZE PALMID WORKSPACE -------------------
# library("palmid")

# Establish Serratus server connection
con <- SerratusConnect()

# Input file
# Generated within `palmid` container
# params are defined in YAML header to expose to CLI
input.path      <- params$input.path

if (is.null(input.path)){
  stop("Error: No input provided.")
}

  input.pp      <- paste0(input.path, '.trim.fa')    # palmscan-palmprint sequence
  input.fev     <- paste0(input.path, '.fev')    # palmscan .fev report
  input.rep     <- paste0(input.path, '.txt')    # palmscan text motif-report
  input.pro     <- paste0(input.path, '.pro')    # diamond palmDB-alignment file
  input.msa     <- paste0(input.path, '.msa.fa') # muscle msa

# Output HTML Report
output.html   <- paste0(input.path, '.html')
save.plots    <- F # save individual plots as png

# Parameters
  id_threshold    <- 0   # Minimum AA% to retain a hit
  max_palmdb_hits <- 500 # Maximum number of alignment hits in PalmDB hits to return

run.time <- Sys.time()

# IMPORT DATASETS -------------------------------
# Import a palmprint-analysis
pp.in <- read.fev(input.fev, FIRST = TRUE)

# Import a diamond-aligned pro file
pro.df <- read.pro(input.pro)
  # Populate with Taxonomy-data
  pro.df     <- get.proTax(pro.df, con)

# Set backstop when too many similar hits come up
palmdb.hits <- length(pro.df$qseqid)
if (palmdb.hits > max_palmdb_hits){
  pro.df <- pro.df[ 1:max_palmdb_hits, ]
  print.hitn <- paste0("Reporting Top ", max_palmdb_hits, "/", palmdb.hits, " matches in PalmDB")
} else {
  print.hitn <-  paste0("Reporting ", palmdb.hits, " matches in PalmDB")
}

# SQL-Import of palmprint/sra meta-data
  # parent/child sOTU lookup, sra, biosample, date, organism, geo
palm.sra <- get.palmSra(pro.df, con)

# GENERATE REPORT-PLOTS -------------------------
# Palmprint Report
pp.report <- PlotReport(pp.in, palmdb)

# Diamond-palmDB Alignment Report
pro.report <- PlotProReport(pro.df, html = T)

# PalmDB Viral Taxonomy Report
tax.report <- PlotTaxReport(pro.df)

# Geospatial distribution Report
geo.report <- PlotGeo2(palm.sra)

# Host/Library organism Report
orgn.report.freq <- PlotOrgn(palm.sra, freq = T)
orgn.report.pidn <- PlotOrgn(palm.sra, freq = F)

```


```{r, echo = FALSE}
noquote(print.hitn)

pro.df %>%
  downloadthis::download_this(
    output_name = paste0(input.path, '.pro'),
    output_extension = ".csv",
    button_label = "Download palmDB.csv",
    button_type = "success",
    has_icon = TRUE,
    icon = "fa fa-file-export"
  )

palm.sra %>%
  downloadthis::download_this(
    output_name = paste0(input.path, '.sra.metadata'),
    output_extension = ".csv",
    button_label = "Download sra.metadata.csv",
    button_type = "success",
    has_icon = TRUE,
    icon = "fa fa-file-export"
  )
```

## RdRP palmprint QC

#### palmscan motif analysis

Identification of the the core catalytic motifs A,B,C 
within the input sequence and reporting the "palmprint"
RNA-virus barcode.

```{r}
# Palmscan-generated reports
system(paste0( 'echo "palmprint sequence: \n" ;
                cat ', input.pp, ';',
               'echo "\ncatalytic-motifs: " ;
                cat ', input.rep ))

#lapply(scan(input.pp, 'raw'),cat)[[1]]

```

#### palmprint QC-report

Quality control metrics on the motif-scores and size distribution
of the "palmprint" informs the confidence that the input sequence
contains a viral RdRP. Input scores are shown compared to score 
distribution from 15,010 canonical viral RdRP from GenBank.

```{r, fig.height = 4.5, fig.width = 9}
# Palmscan QC-plot
plot(pp.report)
```

## Palmprint vs. PalmDB Analysis

#### Multiple Sequence Alignment

A `MUSCLE`-generated multiple sequence alignment of the 
top-10 matching hits in [`palmdb`](https://github.com/rcedgar/palmdb).

```{r}
# Multiple Sequence Alignment of Top-10 hits in palmDB
system( paste0 ('cat ', input.msa ))
```

#### Input palmprint aligned to palmDB

Input "palmprint" are aligned against [`palmdb`](https://github.com/rcedgar/palmdb)
using `diamond` to retrieve related viruses. Upto the top 500 related viruses
are reported.


```{r, fig.height = 5, fig.width = 9}
# Protein-alignment of Input vs. palmDB
ggplotly(pro.report)

```
#### Virus Taxonomy of PalmDB matches

Species-, Genus- and Phylum- level taxonomy of the matching
hits in PalmDB allow for taxonomic-inference of the input
virus.

```{r, fig.height=10, fig.width=16, retina = 1}
# Viral Taxonomy of palmDB Hits
plot(tax.report)
```

```{r, echo = FALSE}
#### Data-Table: `palmDB.csv`
# # Data table for palmDB Alignment
# 
# blast.col <- linkBLAST(pro.df$sseqid, pro.df$full_sseq)
# 
# cbind( pro.df[, c("qseqid", "sseqid", 'tspe', "pident", "evalue", "cigar")],
#        blast.col) %>%
#   DT::datatable(
#     rownames = FALSE, filter = "top", escape = F,
#     options = list(pageLength = 10, scrollX = T)
#   )

```

## SRA Meta-data Analysis

RNA viruses matching input are cross-referenced against
5.7M SRA sequencing libraries to identify sra-virus matches
and their associated meta-data.

#### Geospatial distribution of related RNA viruses

Distribution of matching RNA viruses. Click to explore
each matching record. Species, genus, family and phylum
level matches are red, orange, green and purple, respectively.

```{r, fig.height = 6, fig.width = 9}
# Geo-distribution of palmprint-containing SRA
geo.report
```

#### Source organism

Organisms associated with the matching sequencing libraries.
Word size is scaled by a) proximity of input virus to sra-virus
match or b) frequency of organism tag within all sra-virus matches.

```{r, fig.width=8, fig.height=5, retina = 2, out.width=c('50%', '50%')}
# Plot SRA-Organism Wordcloud - id
# (scaled by AA% proximity to input palmprint)
plot(orgn.report.pidn)
```

```{r, fig.width=8, fig.height=5, retina = 2}
# Plot SRA-Organism Wordcloud - freq
# (scaled by frequency in the SRA)
plot(orgn.report.freq)
```


```{r, echo = FALSE}
#### Data-Table: `sra.metadata.csv`
# # Data table for palmDB Alignment
# 
# blast.col <- linkBLAST(palm.sra$sra_sequence, 
#                        paste0(palm.sra$run_id,"_",palm.sra$palm_id)
#                        )
# 
# cbind( palm.sra[, c("run_id", "biosample_id", 'palm_id', 'pident', 'coverage', 'evalue', 'scientific_name')],
#        blast.col) %>%
#   DT::datatable(
#     rownames = FALSE, filter = "top", escape = F,
#     options = list(pageLength = 10, scrollX = T)
#   )

```

#### Footer

- [Source code](https://github.com/ababaian/palmid)
- [Submit issue / ask question](https://github.com/ababaian/palmid/issues)

To save this report: `File` --> `Save Page As`.

```{r, include=FALSE}
if (save.plots){
  
  # SAVE PP-REPORT
  png(filename = output.report, width = 800, height = 400)
   plot(pp.report)
  dev.off()
  
  # SAVE PRO-REPORT 
  png(filename = output.pro, width = 800, height = 400)
    plot(pro.report)
  dev.off()
  
  # SAVE TAX-REPORT
  ggsave(output.tax,
    plot(tax.report),
    width = 16,
    height = 10,
    dpi = 72
  )
  
  # SAVE GEO-REPORT
  htmlwidgets::saveWidget(geo.report, file=output.geo)

  # SAVE ORGN-REPORT
  png(filename = output.orgn, width = 800, height = 400, res = 100)
    plot(orgn.report)
  dev.off()

}

```

```{r, include = FALSE}
#rmarkdown::render('palmid_dev.Rmd',
#                  output_file = output.html)
```

